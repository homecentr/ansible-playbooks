apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: netboot
  namespace: "{{ k3s_namespace | mandatory }}"
spec:
  podSelector:
    matchLabels:
      app: netboot
  policyTypes:
    - Ingress
  ingress:
    # Web UI
    - ports:
        - protocol: TCP
          port: 3000
      from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
        podSelector:
          matchLabels:
            app.kubernetes.io/name: traefik
{% if netboot_allowed_clients_cidr_blocks is defined and netboot_allowed_clients_cidr_blocks | length %}
    # Boot related port with direct access via dedicated IP
    - ports:
      - protocol: TCP
        port: 80
      - protocol: UDP
        port: 69
      from:
{% for cidr_block in netboot_allowed_clients_cidr_blocks %}
        - ipBlock:
            cidr: "{{ cidr_block }}"
{% endfor -%}
{% endif %}