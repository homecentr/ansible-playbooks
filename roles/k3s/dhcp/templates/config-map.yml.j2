apiVersion: v1
kind: ConfigMap
metadata:
  name: dhcp
  namespace: "{{ k3s_namespace | mandatory }}"
data:
  interfaces:
    INTERFACES="eth0"
  dhcpd.conf: |
    {% raw %}option arch code 93 = unsigned integer 16;{% endraw %}

    subnet {{ dhcp_cluster_internal_subnet | ipaddr('network') }} netmask {{ dhcp_cluster_internal_subnet | ipaddr('netmask') }} {}

{% for subnet in dhcp_subnets %}
    subnet {{ subnet.cidr | ipaddr('network') }} netmask {{ subnet.cidr | ipaddr('netmask') }} {% raw %}{{% endraw %}
      authoritative;
      default-lease-time {{ subnet.default_lease_time_seconds }};
      max-lease-time {{ subnet.max_lease_time_seconds }};
      
      range {{ subnet.ip_range.from }} {{ subnet.ip_range.to }};
      
      option dhcp-server-identifier {{ dhcp_ipv4_address }};
      option routers {{ subnet.gateway }};

      {% if 'dns_domain' in subnet %}
      option domain-name "{{ subnet.dns_domain }}";
      {% endif %}

      {% if 'dns_search_domains' in subnet and subnet.dns_search_domains | length %}
      option domain-search {{ '"' + (subnet.dns_search_domains | join('","')) + '"' }};
      {% endif %}

      option domain-name-servers {{ subnet.dns_servers | join(",") }};

      {% if 'netboot_host' in subnet %}
      allow booting;
      next-server {{ subnet.netboot_host }};

      {% raw %}
      if option arch = 00:07 {
          filename "netboot.xyz.efi";
      } elsif option arch = 00:00 {
          filename "netboot.xyz.kpxe";
      } else {
          filename "netboot.xyz.efi";
      }
      {% endraw %}
      {% endif %}


    {% raw %}}{% endraw %}
{% endfor %}