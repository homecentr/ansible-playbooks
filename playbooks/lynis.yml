---
- name: "Install lynis"
  hosts: all
  become: true
  become_method: sudo
  tasks:
  - name: Check system is supported
    fail:
      msg: "The distribution {{ ansible_distribution }} is not supported in the lynis.yml playbook"
    when: not (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and not (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux')

  ##############################
  ### Debian based systems
  ##############################
  - name: "Install gpg (required to add apt key)"
    ansible.builtin.apt:
      name: gpg
      state: present
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

  - name: "Add Lynis repository apt key"
    ansible.builtin.apt_key:
      keyserver: keyserver.ubuntu.com
      id: 013baa07180c50a7101097ef9de922f1c2fde6c4
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

  - name: "Install apt https support"
    ansible.builtin.apt:
      name: apt-transport-https
      state: present
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

  - name: "Add Lynis repository"
    ansible.builtin.apt_repository:
      repo: "deb https://packages.cisofy.com/community/lynis/deb/ stable main"
      state: present
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

  - name: "Install Lynis"
    ansible.builtin.apt:
      name: lynis
      update_cache: yes
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

  ##############################
  ### Red-hat based systems
  ##############################
  - name: "Update packages required to add Lynis repo"
    yum:
      name:
        - ca-certificates
        - curl
        - nss
        - openssl
      state: latest
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

  - name: "Create repo definition file"
    copy:
      src: rhel.repo
      dest: /etc/yum.repos.d/cisofy-lynis.repo
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

  - name: "Install Lynis"
    yum:
      name: lynis
      update_cache: true
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: "Create profile for Proxmox nodes"
  hosts: proxmox_nodes
  become: true
  become_method: sudo
  tasks:
  - name: Create profile file
    copy:
      dest: /etc/lynis/proxmox-node.prf
      content: |
        # Proxmox needs promiscous mode to pass networking to the VMs
        skip-test=NETW-3015
        # IpTables used to redirect port 443 to 8006
        skip-test=FIRE-4512
        # Postfix is used only by Proxmox internally, this check brings no value
        skip-test=MAIL-8818
        # Physical access to the servers is restricted and this would make emergency resolution much more difficult
        skip-test=BOOT-5122
        # Check does not work correctly on Proxmox (see https://github.com/CISOfy/lynis/issues/788)
        skip-test=KRNL-5788
        # Proxmox does not allow user to change the partition layout
        skip-test=FILE-6310
        # Logging to a centralized log host is currently not feasible
        skip-test=LOGG-2154
        # Legal banners are not important in our set up
        skip-test=BANN-7126
        skip-test=BANN-7130
        # USB devices and similar are useful in our usecase
        skip-test=USB-1000
        skip-test=STRG-1846
        # Only one user signs into the machine, accounting is not needed and is not worth the required resources
        skip-test=ACCT-9622
        skip-test=ACCT-9626
        skip-test=ACCT-9628
        # Proxmox leaves locked account for ceph on purpose
        skip-test=AUTH-9284
        # Not worth the effort, the services are installed by default with Proxmox
        skip-test=BOOT-5264
        # Passwords are just a back up and should not be used anyway, expiring passwords puts us in danger or locking ourselves from the server
        skip-test=AUTH-9229



# TODO: Swarm nodes