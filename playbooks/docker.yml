---
- name: "Install Docker"
  hosts: swarm_nodes
  become: true
  become_method: sudo
  handlers:
  - name: restart-node
    reboot:
      reboot_timeout: 10 * 60 # Wait up to 10 minutes for the host to start

  tasks:
  - name: Install Docker
    import_role:
      name: geerlingguy.docker
    notify: restart-node
    vars:
      docker_edition: 'ce'
      docker_users:
        - "{{ admin_user }}"
      docker_service_state: started
      docker_install_compose: true
      docker_compose_version: "1.29.2"
      
  - name: Unify docker group gid across nodes
    ansible.builtin.group:
      name: docker
      state: present
      gid: "{{ docker_gid }}"

  - name: Make sure pip is installed
    apt:
      name: python3-pip
      state: present

  - name: Install docker-py to allow ansible manage Docker
    pip:
      name: docker-py
      state: present
  